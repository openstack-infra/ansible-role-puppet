---
- name: run puppet
  puppet:
    puppetmaster: "{{ puppetmaster|default(omit) }}"
    manifest: "{{ manifest|default(omit) }}"
    show_diff: "{{ show_diff|default(omit) }}"
    facts: "{{ facts|default(omit) }}"
    facter_basename: "{{ facter_basename|default(omit) }}"
- name: find logs
  shell: "ls -tr /var/lib/puppet/reports/{{ ansible_fqdn }}/*yaml"
  register: files
  when: manifest is defined
- name: set log filename
  set_fact: puppet_logfile="{{ files.stdout_lines|sort|last }}"
  when: manifest is defined
- name: fetch file
  synchronize:
    mode: pull
    src: "{{ puppet_logfile }}"
    dest: /var/lib/puppet/reports/{{ ansible_fqdn }}
  when: manifest is defined
- name: post facts
  puppet_post_puppetdb:
    puppetdb: "{{ puppetdb }}"
    hostvars: hostvars[inventory_hostname]
    logfile: "{{ puppet_logfile }}"
  delegate_to: localhost
  connection: local
  when: puppetdb is defined
